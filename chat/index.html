<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rust Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        #chat-container { margin-top: 20px; }
        #messages { height: 300px; overflow-y: scroll; }
        #user-list { list-style: none; padding: 0; }
        #user-list li { padding: 5px 0; }
    </style>
</head>
<body>
    <div id="auth" class="container" style="max-width: 400px; margin-top: 50px;">
        <h2 class="text-center">Login</h2>
        <div class="mb-3">
            <input type="text" id="login-username" class="form-control" placeholder="Username" />
        </div>
        <div class="mb-3">
            <input type="password" id="login-password" class="form-control" placeholder="Password" />
        </div>
        <button onclick="login()" class="btn btn-primary w-100">Login</button>

        <hr>

        <h2 class="text-center">Signup</h2>
        <div class="mb-3">
            <input type="text" id="signup-username" class="form-control" placeholder="Username" />
        </div>
        <div class="mb-3">
            <input type="password" id="signup-password" class="form-control" placeholder="Password" />
        </div>
        <button onclick="signup()" class="btn btn-success w-100">Signup</button>
    </div>

    <div id="chat-container" class="container d-flex" style="display: none;">
        <div id="users" class="me-3" style="width: 20%;">
            <h3>Online Users</h3>
            <ul id="user-list" class="list-group"></ul>
        </div>
        <div id="chat" style="width: 80%;">
            <h2>Chat Room</h2>
            <div id="messages" class="border rounded p-3 mb-3 bg-white"></div>
            <div id="input" class="input-group">
                <input type="text" id="message" class="form-control" placeholder="Type a message..." />
                <select id="recipient" class="form-select">
                    <option value="public">Public</option>
                </select>
                <button onclick="sendMessage()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let token = null;
        let ws = null;
        let onlineUsers = [];

        function signup() {
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            fetch('/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(response => response.text())
                .then(data => alert(data))
                .catch(err => console.error(err));
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('Login failed');
                })
                .then(data => {
                    token = data.token;
                    document.getElementById('auth').style.display = 'none';
                    document.getElementById('chat-container').style.display = 'flex';
                    connectWebSocket();
                    loadHistory();
                    fetchOnlineUsers();
                })
                .catch(err => alert(err.message));
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8080/ws/?token=" + token);

            ws.onopen = () => {
                console.log("Connected to the server");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'public') {
                    addMessage(`${data.from}: ${data.content}`);
                } else if (data.type === 'private') {
                    addMessage(`Private from ${data.from}: ${data.content}`);
                }
                // Update online users if necessary
                if (data.type === 'user_list') {
                    updateUserList(data.users);
                }
            };

            ws.onclose = () => {
                console.log("Disconnected from server");
            };
        }

        function sendMessage() {
            const input = document.getElementById('message');
            const recipient = document.getElementById('recipient').value;
            const message = input.value.trim();
            if (message !== "") {
                const payload = { recipient, content: message };
                ws.send(JSON.stringify(payload));
                input.value = '';
            }
        }

        function addMessage(message) {
            const messages = document.getElementById('messages');
            const msg = document.createElement('div');
            if (message.startsWith("Private")) {
                msg.className = 'alert alert-secondary';
            } else {
                msg.className = 'alert alert-primary';
            }
            msg.textContent = message;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function loadHistory() {
            fetch('/history?token=' + token)
                .then(response => response.json())
                .then(data => {
                    const messages = document.getElementById('messages');
                    data.forEach(msg => {
                        const div = document.createElement('div');
                        div.textContent = msg;
                        messages.appendChild(div);
                    });
                    messages.scrollTop = messages.scrollHeight;
                })
                .catch(err => console.error(err));
        }

        function fetchOnlineUsers() {
            fetch('/online_users?token=' + token)
                .then(response => response.json())
                .then(data => {
                    onlineUsers = data.users.filter(user => user !== getUsernameFromToken());
                    updateUserList(onlineUsers);
                })
                .catch(err => console.error(err));
        }

        function updateUserList(users) {
            const userList = document.getElementById('user-list');
            const recipientSelect = document.getElementById('recipient');
            userList.innerHTML = '';
            recipientSelect.innerHTML = '<option value="public">Public</option>';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = user;
                userList.appendChild(li);

                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                recipientSelect.appendChild(option);
            });
        }

        function getUsernameFromToken() {
            // Implement a way to decode the token to get the username, or store it upon login
            // For simplicity, assume it's stored elsewhere
            return 'your_username';
        }

        // Send message on Enter key
        document.getElementById('message').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
